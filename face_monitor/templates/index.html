<!DOCTYPE html>
<html>
<head>
    <title>Webcam Face Recognition Exam</title>
</head>
<body>
    <input type="text" id="studentName" placeholder="Enter Student Name">
    <button onclick="startExam()">Start Exam</button>
    <video id="webcam" width="640" height="480" autoplay></video>
    <canvas id="canvas" style="display: none;"></canvas>
    <div id="results"></div>
    <div id="studentData"></div>

    <script>
        const video = document.getElementById('webcam');
        const canvas = document.getElementById('canvas');
        const resultsDiv = document.getElementById('results');
        const studentDataDiv = document.getElementById('studentData');
        const studentNameInput = document.getElementById('studentName');
        const context = canvas.getContext('2d');
        let cameraActive = true;

        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => {
                video.srcObject = stream;
            })
            .catch(error => {
                console.error('Error accessing webcam:', error);
            });

        function startExam() {
            const studentName = studentNameInput.value;
            fetch('/start_exam', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `student_name=${encodeURIComponent(studentName)}`
            })
            .then(response => response.json())
            .then(data => {
                resultsDiv.textContent = data.message || data.error;
            });
        }

        setInterval(() => {
            if (cameraActive) {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                canvas.toBlob(blob => {
                    const formData = new FormData();
                    formData.append('image', blob, 'webcam.jpg');

                    fetch('/upload', {
                        method: 'POST',
                        body: formData,
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.names) {
                            resultsDiv.textContent = 'Faces: ' + data.names.join(', ');
                            context.strokeStyle = 'red';
                            if (data.locations) {
                                data.locations.forEach(loc => {
                                    context.strokeRect(loc.left, loc.top, loc.right - loc.left, loc.bottom - loc.top);
                                });
                            }
                            fetch(`/get_student_data/${data.names[0]}`)
                            .then(response => response.json())
                            .then(studentData => {
                                studentDataDiv.textContent = JSON.stringify(studentData);
                            });

                        } else if (data.warning) {
                            resultsDiv.textContent = data.warning;
                            if (data.camera_off) {
                                cameraActive = false;
                                video.srcObject.getTracks().forEach(track => track.stop());
                                video.srcObject = null;
                            }
                            fetch(`/get_student_data/${studentNameInput.value}`)
                            .then(response => response.json())
                            .then(studentData => {
                                studentDataDiv.textContent = JSON.stringify(studentData);
                            });
                        } else if(data.error) {
                            resultsDiv.textContent = data.error;
                        } else {
                            resultsDiv.textContent = 'No faces detected.';
                        }
                    });
                }, 'image/jpeg');
            }
        }, 3000);
    </script>
</body>
</html>